var Qn=Object.defineProperty;var Vn=n=>{throw TypeError(n)};var jn=(n,t,e)=>t in n?Qn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var E=(n,t,e)=>jn(n,typeof t!="symbol"?t+"":t,e),bn=(n,t,e)=>t.has(n)||Vn("Cannot "+e);var ce=(n,t,e)=>(bn(n,t,"read from private field"),e?e.call(n):t.get(n)),Ke=(n,t,e)=>t.has(n)?Vn("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),ve=(n,t,e,r)=>(bn(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e);var O=(n=>(n.WEB_BLUETOOTH_NOT_SUPPORTED="WEB_BLUETOOTH_NOT_SUPPORTED",n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTION_FAILED="CONNECTION_FAILURE",n.DISCONNECT_FAILED="DISCONNECT_FAILURE",n.WRITE_FAILED="WRITE_FAILURE",n.SUBSCRIBE_FAILED="SUBSCRIBE_FAILURE",n.TIMEOUT="TIMEOUT",n.PARSE_ERROR="PARSE_ERROR",n.NO_TRANSPORT="NO_TRANSPORT",n.UNKNOWN_ERROR="UNKNOWN_ERROR",n.UNSUPPORTED_FEATURE="UNSUPPORTED_FEATURE",n.INVALID_PARAMETER="INVALID_PARAMETER",n.ALREADY_EXISTS="ALREADY_EXISTS",n))(O||{});class R extends Error{constructor(t,e,r){super(e),this.id=t,this.cause=r,this.name="BoksClientError"}}var s=(n=>(n[n.OPEN_DOOR=1]="OPEN_DOOR",n[n.ASK_DOOR_STATUS=2]="ASK_DOOR_STATUS",n[n.REQUEST_LOGS=3]="REQUEST_LOGS",n[n.REBOOT=6]="REBOOT",n[n.GET_LOGS_COUNT=7]="GET_LOGS_COUNT",n[n.TEST_BATTERY=8]="TEST_BATTERY",n[n.MASTER_CODE_EDIT=9]="MASTER_CODE_EDIT",n[n.SINGLE_USE_CODE_TO_MULTI=10]="SINGLE_USE_CODE_TO_MULTI",n[n.MULTI_CODE_TO_SINGLE_USE=11]="MULTI_CODE_TO_SINGLE_USE",n[n.DELETE_MASTER_CODE=12]="DELETE_MASTER_CODE",n[n.DELETE_SINGLE_USE_CODE=13]="DELETE_SINGLE_USE_CODE",n[n.DELETE_MULTI_USE_CODE=14]="DELETE_MULTI_USE_CODE",n[n.REACTIVATE_CODE=15]="REACTIVATE_CODE",n[n.GENERATE_CODES=16]="GENERATE_CODES",n[n.CREATE_MASTER_CODE=17]="CREATE_MASTER_CODE",n[n.CREATE_SINGLE_USE_CODE=18]="CREATE_SINGLE_USE_CODE",n[n.CREATE_MULTI_USE_CODE=19]="CREATE_MULTI_USE_CODE",n[n.COUNT_CODES=20]="COUNT_CODES",n[n.GENERATE_CODES_SUPPORT=21]="GENERATE_CODES_SUPPORT",n[n.SET_CONFIGURATION=22]="SET_CONFIGURATION",n[n.REGISTER_NFC_TAG_SCAN_START=23]="REGISTER_NFC_TAG_SCAN_START",n[n.REGISTER_NFC_TAG=24]="REGISTER_NFC_TAG",n[n.UNREGISTER_NFC_TAG=25]="UNREGISTER_NFC_TAG",n[n.RE_GENERATE_CODES_PART1=32]="RE_GENERATE_CODES_PART1",n[n.RE_GENERATE_CODES_PART2=33]="RE_GENERATE_CODES_PART2",n[n.SCALE_BOND=80]="SCALE_BOND",n[n.SCALE_GET_MAC_ADDRESS_BOKS=82]="SCALE_GET_MAC_ADDRESS_BOKS",n[n.SCALE_FORGET_BONDING=83]="SCALE_FORGET_BONDING",n[n.SCALE_TARE_EMPTY=85]="SCALE_TARE_EMPTY",n[n.SCALE_TARE_LOADED=86]="SCALE_TARE_LOADED",n[n.SCALE_MEASURE_WEIGHT=87]="SCALE_MEASURE_WEIGHT",n[n.SCALE_PREPARE_DFU=96]="SCALE_PREPARE_DFU",n[n.SCALE_GET_RAW_SENSORS=97]="SCALE_GET_RAW_SENSORS",n[n.SCALE_RECONNECT=98]="SCALE_RECONNECT",n[n.CODE_OPERATION_SUCCESS=119]="CODE_OPERATION_SUCCESS",n[n.CODE_OPERATION_ERROR=120]="CODE_OPERATION_ERROR",n[n.NOTIFY_LOGS_COUNT=121]="NOTIFY_LOGS_COUNT",n[n.ERROR_COMMAND_NOT_SUPPORTED=128]="ERROR_COMMAND_NOT_SUPPORTED",n[n.VALID_OPEN_CODE=129]="VALID_OPEN_CODE",n[n.INVALID_OPEN_CODE=130]="INVALID_OPEN_CODE",n[n.NOTIFY_DOOR_STATUS=132]="NOTIFY_DOOR_STATUS",n[n.ANSWER_DOOR_STATUS=133]="ANSWER_DOOR_STATUS",n[n.LOG_CODE_BLE_VALID=134]="LOG_CODE_BLE_VALID",n[n.LOG_CODE_KEY_VALID=135]="LOG_CODE_KEY_VALID",n[n.LOG_CODE_BLE_INVALID=136]="LOG_CODE_BLE_INVALID",n[n.LOG_CODE_KEY_INVALID=137]="LOG_CODE_KEY_INVALID",n[n.LOG_DOOR_CLOSE=144]="LOG_DOOR_CLOSE",n[n.LOG_DOOR_OPEN=145]="LOG_DOOR_OPEN",n[n.LOG_END_HISTORY=146]="LOG_END_HISTORY",n[n.LOG_HISTORY_ERASE=147]="LOG_HISTORY_ERASE",n[n.POWER_OFF=148]="POWER_OFF",n[n.BLOCK_RESET=149]="BLOCK_RESET",n[n.POWER_ON=150]="POWER_ON",n[n.BLE_REBOOT=151]="BLE_REBOOT",n[n.LOG_EVENT_SCALE_MEASURE=152]="LOG_EVENT_SCALE_MEASURE",n[n.LOG_EVENT_KEY_OPENING=153]="LOG_EVENT_KEY_OPENING",n[n.LOG_EVENT_ERROR=160]="LOG_EVENT_ERROR",n[n.LOG_EVENT_NFC_OPENING=161]="LOG_EVENT_NFC_OPENING",n[n.LOG_EVENT_NFC_REGISTERING=162]="LOG_EVENT_NFC_REGISTERING",n[n.NOTIFY_CODES_COUNT=195]="NOTIFY_CODES_COUNT",n[n.NOTIFY_SET_CONFIGURATION_SUCCESS=196]="NOTIFY_SET_CONFIGURATION_SUCCESS",n[n.NOTIFY_NFC_TAG_FOUND=197]="NOTIFY_NFC_TAG_FOUND",n[n.ERROR_NFC_TAG_ALREADY_EXISTS_SCAN=198]="ERROR_NFC_TAG_ALREADY_EXISTS_SCAN",n[n.ERROR_NFC_SCAN_TIMEOUT=199]="ERROR_NFC_SCAN_TIMEOUT",n[n.NOTIFY_NFC_TAG_REGISTERED=200]="NOTIFY_NFC_TAG_REGISTERED",n[n.NOTIFY_NFC_TAG_REGISTERED_ERROR_ALREADY_EXISTS=201]="NOTIFY_NFC_TAG_REGISTERED_ERROR_ALREADY_EXISTS",n[n.NOTIFY_NFC_TAG_UNREGISTERED=202]="NOTIFY_NFC_TAG_UNREGISTERED",n[n.NOTIFY_CODE_GENERATION_SUCCESS=192]="NOTIFY_CODE_GENERATION_SUCCESS",n[n.NOTIFY_CODE_GENERATION_ERROR=193]="NOTIFY_CODE_GENERATION_ERROR",n[n.NOTIFY_CODE_GENERATION_PROGRESS=194]="NOTIFY_CODE_GENERATION_PROGRESS",n[n.NOTIFY_SCALE_BONDING_SUCCESS=176]="NOTIFY_SCALE_BONDING_SUCCESS",n[n.NOTIFY_SCALE_BONDING_ERROR=177]="NOTIFY_SCALE_BONDING_ERROR",n[n.NOTIFY_MAC_ADDRESS_BOKS_SCALE=178]="NOTIFY_MAC_ADDRESS_BOKS_SCALE",n[n.NOTIFY_SCALE_BONDING_FORGET_SUCCESS=179]="NOTIFY_SCALE_BONDING_FORGET_SUCCESS",n[n.NOTIFY_SCALE_BONDING_PROGRESS=180]="NOTIFY_SCALE_BONDING_PROGRESS",n[n.NOTIFY_SCALE_TARE_EMPTY_OK=181]="NOTIFY_SCALE_TARE_EMPTY_OK",n[n.NOTIFY_SCALE_TARE_LOADED_OK=182]="NOTIFY_SCALE_TARE_LOADED_OK",n[n.NOTIFY_SCALE_MEASURE_WEIGHT=183]="NOTIFY_SCALE_MEASURE_WEIGHT",n[n.NOTIFY_SCALE_DISCONNECTED=184]="NOTIFY_SCALE_DISCONNECTED",n[n.NOTIFY_SCALE_RAW_SENSORS=185]="NOTIFY_SCALE_RAW_SENSORS",n[n.NOTIFY_SCALE_FAULTY=186]="NOTIFY_SCALE_FAULTY",n[n.ERROR_CRC=224]="ERROR_CRC",n[n.ERROR_UNAUTHORIZED=225]="ERROR_UNAUTHORIZED",n[n.ERROR_BAD_REQUEST=226]="ERROR_BAD_REQUEST",n))(s||{});const N={DFU_SERVICE:"0000fe59-0000-1000-8000-00805f9b34fb",DFU_CONTROL_POINT:"8ec90001-f315-4f60-9fb8-838830daea50",SERVICE:"a7630001-f491-4f21-95ea-846ba586e361",WRITE:"a7630002-f491-4f21-95ea-846ba586e361",NOTIFY:"a7630003-f491-4f21-95ea-846ba586e361",CUSTOM_BATTERY:"00000004-0000-1000-8000-00805f9b34fb",BATTERY_SERVICE:"0000180f-0000-1000-8000-00805f9b34fb",BATTERY_LEVEL:"00002a19-0000-1000-8000-00805f9b34fb",DEVICE_INFO_SERVICE:"0000180a-0000-1000-8000-00805f9b34fb",FIRMWARE_REVISION:"00002a26-0000-1000-8000-00805f9b34fb",SOFTWARE_REVISION:"00002a28-0000-1000-8000-00805f9b34fb",HARDWARE_REVISION:"00002a27-0000-1000-8000-00805f9b34fb"},Zn=255,g=255;var Wn=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n[n.Master=2]="Master",n))(Wn||{});class zn{constructor(t){E(this,"device",null);E(this,"server",null);E(this,"writeChar",null);E(this,"notifyChar",null);t&&(this.device=t)}async connect(){var t;if(!this.device&&(typeof navigator>"u"||!navigator.bluetooth))throw new R(O.WEB_BLUETOOTH_NOT_SUPPORTED,"Web Bluetooth is not supported in this environment.");try{if(this.device||(this.device=await navigator.bluetooth.requestDevice({filters:[{services:[N.SERVICE]}],optionalServices:[N.SERVICE,N.BATTERY_SERVICE,N.DEVICE_INFO_SERVICE]})),!((t=this.device)!=null&&t.gatt))throw new R(O.CONNECTION_FAILED,"GATT Server not available.");this.server=await this.device.gatt.connect();const e=await this.server.getPrimaryService(N.SERVICE);this.writeChar=await e.getCharacteristic(N.WRITE),this.notifyChar=await e.getCharacteristic(N.NOTIFY)}catch(e){throw e instanceof R?e:new R(O.CONNECTION_FAILED,"Failed to connect to Boks device",e)}}async disconnect(){var t;try{(t=this.server)!=null&&t.connected&&this.server.disconnect()}catch(e){throw new R(O.DISCONNECT_FAILED,"Failed to disconnect",e)}}async write(t){if(!this.writeChar)throw new R(O.NOT_CONNECTED,"Not connected (Write characteristic missing).");try{await this.writeChar.writeValueWithResponse(t)}catch(e){throw new R(O.WRITE_FAILED,"Failed to write to Boks device",e)}}async read(t){var e;if(!((e=this.server)!=null&&e.connected))throw new R(O.NOT_CONNECTED,"Not connected to GATT server.");try{const r=await this.server.getPrimaryServices();for(const i of r)try{const o=await(await i.getCharacteristic(t)).readValue();return new Uint8Array(o.buffer)}catch{}throw new Error(`Characteristic ${t} not found in any visible service.`)}catch(r){throw new R(O.PARSE_ERROR,`Failed to read characteristic ${t}`,r)}}async subscribe(t){if(!this.notifyChar)throw new R(O.NOT_CONNECTED,"Not connected (Notify characteristic missing).");try{await this.notifyChar.startNotifications(),this.notifyChar.addEventListener("characteristicvaluechanged",e=>{const i=e.target.value;i&&t(new Uint8Array(i.buffer))})}catch(e){throw new R(O.SUBSCRIBE_FAILED,"Failed to subscribe to notifications",e)}}}const Jn=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0").toUpperCase()),ne=new Uint8Array(256);ne.fill(255);for(let n=0;n<10;n++)ne[48+n]=n;for(let n=0;n<6;n++)ne[65+n]=10+n;const I=n=>{const t=n.replace(/\s/g,"");if(t.length%2!==0)throw new Error("Invalid hex string");const e=t.length,r=new Uint8Array(e/2);for(let i=0;i<e;i+=2){const c=ne[t.charCodeAt(i)],o=ne[t.charCodeAt(i+1)];if(c===255||o===255)throw new Error("Invalid hex character");r[i/2]=c<<4|o}return r},d=n=>{const t=n.length,e=new Array(t);for(let r=0;r<t;r++)e[r]=Jn[n[r]];return e.join("")},h=n=>new TextEncoder().encode(n),_=n=>new TextDecoder().decode(n).replace(/\0/g,""),$n=n=>{let t=0;for(let e=0;e<n.length;e++)t+=n[e];return t&Zn};class u{constructor(){E(this,"rawPayload",new Uint8Array(0))}static fromPayload(t){throw new Error("fromPayload not implemented")}encode(){const t=this.toPayload(),e=new Uint8Array(t.length+3);return e[0]=this.opcode,e[1]=t.length,e.set(t,2),e[e.length-1]=$n(e.subarray(0,e.length-1)),e}}var re=(n=>(n.INVALID_PAYLOAD_LENGTH="INVALID_PAYLOAD_LENGTH",n.INVALID_CONFIG_KEY="INVALID_CONFIG_KEY",n.INVALID_VALUE="INVALID_VALUE",n.MALFORMED_DATA="MALFORMED_DATA",n))(re||{});class oe extends Error{constructor(t,e,r){super(e),this.id=t,this.context=r,this.name="BoksProtocolError"}}function w(n){if(!/^[0-9A-B]{6}$/.test(n))throw new oe(re.INVALID_VALUE,"PIN must be exactly 6 characters using only 0-9, A, and B",{received:n})}const L=class L extends u{constructor(t){super(),this.pin=t,w(t)}get opcode(){return L.opcode}static fromPayload(t){return new L(_(t))}toPayload(){return h(this.pin)}};E(L,"opcode",s.OPEN_DOOR);let ae=L;const U=class U extends u{get opcode(){return U.opcode}static fromPayload(t){return new U}toPayload(){return new Uint8Array(0)}};E(U,"opcode",s.ASK_DOOR_STATUS);let _e=U;const F=class F extends u{get opcode(){return F.opcode}static fromPayload(t){return new F}toPayload(){return new Uint8Array(0)}};E(F,"opcode",s.REQUEST_LOGS);let Te=F;const G=class G extends u{get opcode(){return G.opcode}static fromPayload(t){return new G}toPayload(){return new Uint8Array(0)}};E(G,"opcode",s.REBOOT);let Oe=G;const m=class m extends u{get opcode(){return m.opcode}static fromPayload(t){return new m}toPayload(){return new Uint8Array(0)}};E(m,"opcode",s.GET_LOGS_COUNT);let Re=m;const y=class y extends u{get opcode(){return y.opcode}static fromPayload(t){return new y}toPayload(){return new Uint8Array(0)}};E(y,"opcode",s.TEST_BATTERY);let he=y;class l extends u{constructor(t){if(super(),this.configKey=t,!/^[0-9A-F]{8}$/.test(t))throw new oe(re.INVALID_CONFIG_KEY,"Config Key must be exactly 8 uppercase hexadecimal characters")}}const Y=class Y extends l{constructor(t,e,r){super(t),this.index=e,this.newPin=r,w(r)}get opcode(){return Y.opcode}static fromPayload(t){const e=_(t.slice(0,8));let r=0;t.length>8&&(r=t[8]);const i=_(t.slice(9,15));return new Y(e,r,i)}toPayload(){const t=new Uint8Array(15);t.set(h(this.configKey),0),t[8]=this.index;const e=h(this.newPin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,9),t}};E(Y,"opcode",s.MASTER_CODE_EDIT);let ue=Y;const x=class x extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return x.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new x(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(x,"opcode",s.SINGLE_USE_CODE_TO_MULTI);let Ae=x;const P=class P extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return P.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new P(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(P,"opcode",s.MULTI_CODE_TO_SINGLE_USE);let Se=P;const p=class p extends l{constructor(t,e){super(t),this.index=e}get opcode(){return p.opcode}static fromPayload(t){const e=_(t.slice(0,8));let r=0;return t.length>8&&(r=t[8]),new p(e,r)}toPayload(){const t=new Uint8Array(9);return t.set(h(this.configKey),0),t[8]=this.index,t}};E(p,"opcode",s.DELETE_MASTER_CODE);let le=p;const K=class K extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return K.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new K(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(K,"opcode",s.DELETE_SINGLE_USE_CODE);let Ne=K;const v=class v extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return v.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new v(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(v,"opcode",s.DELETE_MULTI_USE_CODE);let Ce=v;const V=class V extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return V.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new V(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(V,"opcode",s.REACTIVATE_CODE);let we=V;const b=class b extends u{constructor(t){super(),this.seed=t}get opcode(){return b.opcode}static fromPayload(t){return new b(t)}toPayload(){const t=typeof this.seed=="string"?I(this.seed):this.seed;if(t.length!==32)throw new Error("Seed must be exactly 32 bytes");return t}};E(b,"opcode",s.GENERATE_CODES);let Ie=b;const M=class M extends l{constructor(t,e,r){super(t),this.index=e,this.pin=r,w(r)}get opcode(){return M.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));let i=0;return t.length>14&&(i=t[14]),new M(e,i,r)}toPayload(){const t=new Uint8Array(15);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t[14]=this.index,t}};E(M,"opcode",s.CREATE_MASTER_CODE);let fe=M;const W=class W extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return W.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new W(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E(W,"opcode",s.CREATE_SINGLE_USE_CODE);let De=W;const $=class $ extends l{constructor(t,e){super(t),this.pin=e,w(e)}get opcode(){return $.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=_(t.slice(8,14));return new $(e,r)}toPayload(){const t=new Uint8Array(14);t.set(h(this.configKey),0);const e=h(this.pin),r=new Uint8Array(6);return r.set(e.slice(0,6)),t.set(r,8),t}};E($,"opcode",s.CREATE_MULTI_USE_CODE);let de=$;const H=class H extends u{get opcode(){return H.opcode}static fromPayload(t){return new H}toPayload(){return new Uint8Array(0)}};E(H,"opcode",s.COUNT_CODES);let ge=H;const X=class X extends u{constructor(t){super(),this.seed=t}get opcode(){return X.opcode}static fromPayload(t){return new X(t)}toPayload(){const t=typeof this.seed=="string"?I(this.seed):this.seed;if(t.length!==32)throw new Error("Seed must be exactly 32 bytes");return t}};E(X,"opcode",s.GENERATE_CODES_SUPPORT);let Ve=X;const Q=class Q extends l{constructor(t,e,r){super(t),this.configType=e,this.value=r}get opcode(){return Q.opcode}static fromPayload(t){if(t.length!==10)throw new oe(re.INVALID_PAYLOAD_LENGTH,"SetConfigurationPacket must be exactly 10 bytes long",{received:t.length,expected:10});const e=_(t.subarray(0,8)),r=t[8],i=t[9];if(i!==0&&i!==1)throw new oe(re.INVALID_VALUE,"SetConfigurationPacket value must be 0x00 or 0x01",{received:i});return new Q(e,r,i===1)}toPayload(){const t=new Uint8Array(10);return t.set(h(this.configKey),0),t[8]=this.configType,t[9]=this.value?1:0,t}};E(Q,"opcode",s.SET_CONFIGURATION);let Le=Q;const j=class j extends l{get opcode(){return j.opcode}constructor(t){super(t)}static fromPayload(t){const e=_(t.slice(0,8));return new j(e)}toPayload(){return h(this.configKey)}};E(j,"opcode",s.REGISTER_NFC_TAG_SCAN_START);let Ue=j;const Z=class Z extends l{constructor(t,e){super(t),this.uid=e}get opcode(){return Z.opcode}static fromPayload(t){var i;const e=_(t.slice(0,8));let r="";if(t.length>8){const c=t[8];t.length>=9+c&&(r=((i=d(t.slice(9,9+c)).match(/.{1,2}/g))==null?void 0:i.join(":"))||"")}return new Z(e,r)}toPayload(){const t=I(this.uid.replace(/:/g,"")),e=new Uint8Array(9+t.length);return e.set(h(this.configKey),0),e[8]=t.length,e.set(t,9),e}};E(Z,"opcode",s.REGISTER_NFC_TAG);let Fe=Z;const z=class z extends l{constructor(t,e){super(t),this.uid=e}get opcode(){return z.opcode}static fromPayload(t){var i;const e=_(t.slice(0,8));let r="";if(t.length>8){const c=t[8];t.length>=9+c&&(r=((i=d(t.slice(9,9+c)).match(/.{1,2}/g))==null?void 0:i.join(":"))||"")}return new z(e,r)}toPayload(){const t=I(this.uid.replace(/:/g,"")),e=new Uint8Array(9+t.length);return e.set(h(this.configKey),0),e[8]=t.length,e.set(t,9),e}};E(z,"opcode",s.UNREGISTER_NFC_TAG);let Ge=z;const J=class J extends l{constructor(t,e){if(super(t),this.part=e,e.length!==16)throw new Error("Token part must be exactly 16 bytes")}get opcode(){return J.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=t.slice(8,24);return new J(e,r)}toPayload(){const t=new Uint8Array(24);return t.set(h(this.configKey),0),t.set(this.part,8),t}};E(J,"opcode",s.RE_GENERATE_CODES_PART1);let se=J;const q=class q extends l{constructor(t,e){if(super(t),this.part=e,e.length!==16)throw new Error("Token part must be exactly 16 bytes")}get opcode(){return q.opcode}static fromPayload(t){const e=_(t.slice(0,8)),r=t.slice(8,24);return new q(e,r)}toPayload(){const t=new Uint8Array(24);return t.set(h(this.configKey),0),t.set(this.part,8),t}};E(q,"opcode",s.RE_GENERATE_CODES_PART2);let ie=q;const B=class B extends u{constructor(t=new Uint8Array(0)){super(),this.data=t}get opcode(){return B.opcode}static fromPayload(t){return new B(t)}toPayload(){return this.data}};E(B,"opcode",s.SCALE_BOND);let me=B;const k=class k extends u{get opcode(){return k.opcode}static fromPayload(t){return new k}toPayload(){return new Uint8Array(0)}};E(k,"opcode",s.SCALE_GET_MAC_ADDRESS_BOKS);let be=k;const tt=class tt extends u{get opcode(){return tt.opcode}static fromPayload(t){return new tt}toPayload(){return new Uint8Array(0)}};E(tt,"opcode",s.SCALE_FORGET_BONDING);let ye=tt;const et=class et extends u{get opcode(){return et.opcode}static fromPayload(t){return new et}toPayload(){return new Uint8Array(0)}};E(et,"opcode",s.SCALE_TARE_EMPTY);let Ye=et;const nt=class nt extends u{constructor(t=new Uint8Array(0)){super(),this.data=t}get opcode(){return nt.opcode}static fromPayload(t){return new nt(t)}toPayload(){return this.data}};E(nt,"opcode",s.SCALE_TARE_LOADED);let xe=nt;const rt=class rt extends u{get opcode(){return rt.opcode}static fromPayload(t){return new rt}toPayload(){return new Uint8Array(0)}};E(rt,"opcode",s.SCALE_MEASURE_WEIGHT);let Pe=rt;const st=class st extends u{get opcode(){return st.opcode}static fromPayload(t){return new st}toPayload(){return new Uint8Array(0)}};E(st,"opcode",s.SCALE_PREPARE_DFU);let Me=st;const it=class it extends u{get opcode(){return it.opcode}static fromPayload(t){return new it}toPayload(){return new Uint8Array(0)}};E(it,"opcode",s.SCALE_GET_RAW_SENSORS);let pe=it;const Et=class Et extends u{get opcode(){return Et.opcode}static fromPayload(t){return new Et}toPayload(){return new Uint8Array(0)}};E(Et,"opcode",s.SCALE_RECONNECT);let We=Et;class a extends u{constructor(t,e){super(),this._opcode=t,this._rawPayload=e,e&&(this.rawPayload=e)}get opcode(){return this._opcode}toPayload(){return this.rawPayload}}const ct=class ct extends a{constructor(t){super(ct.opcode,t)}static fromPayload(t){return new ct(t)}};E(ct,"opcode",s.NOTIFY_SCALE_BONDING_SUCCESS);let $e=ct;const ot=class ot extends a{constructor(t=0,e){super(ot.opcode,e),this.errorCode=t}static fromPayload(t){let e=0;return t.length>0&&(e=t[0]),new ot(e,t)}};E(ot,"opcode",s.NOTIFY_SCALE_BONDING_ERROR);let He=ot;const at=class at extends a{constructor(t="",e){super(at.opcode,e),this.macAddress=t}static fromPayload(t){var r;const e=((r=d(t).match(/.{1,2}/g))==null?void 0:r.join(":"))||"";return new at(e,t)}};E(at,"opcode",s.NOTIFY_MAC_ADDRESS_BOKS_SCALE);let Xe=at;const _t=class _t extends a{constructor(t){super(_t.opcode,t)}static fromPayload(t){return new _t(t)}};E(_t,"opcode",s.NOTIFY_SCALE_BONDING_FORGET_SUCCESS);let Qe=_t;const Tt=class Tt extends a{constructor(t=0,e){super(Tt.opcode,e),this.progress=t}static fromPayload(t){let e=0;return t.length>0&&(e=t[0]),new Tt(e,t)}};E(Tt,"opcode",s.NOTIFY_SCALE_BONDING_PROGRESS);let je=Tt;const Ot=class Ot extends a{constructor(t){super(Ot.opcode,t)}static fromPayload(t){return new Ot(t)}};E(Ot,"opcode",s.NOTIFY_SCALE_TARE_EMPTY_OK);let Ze=Ot;const Rt=class Rt extends a{constructor(t){super(Rt.opcode,t)}static fromPayload(t){return new Rt(t)}};E(Rt,"opcode",s.NOTIFY_SCALE_TARE_LOADED_OK);let ze=Rt;const ht=class ht extends a{constructor(t=0,e){super(ht.opcode,e),this.weight=t}static fromPayload(t){let e=0;if(t.length>=4){const r=t[0]!==0?-1:1,i=t[1]<<16|t[2]<<8|t[3];e=r*i}return new ht(e,t)}};E(ht,"opcode",s.NOTIFY_SCALE_MEASURE_WEIGHT);let Je=ht;const ut=class ut extends a{constructor(t){super(ut.opcode,t)}static fromPayload(t){return new ut(t)}};E(ut,"opcode",s.NOTIFY_SCALE_DISCONNECTED);let qe=ut;const At=class At extends a{constructor(t=new Uint8Array(0),e){super(At.opcode,e),this.data=t}static fromPayload(t){return new At(t,t)}};E(At,"opcode",s.NOTIFY_SCALE_RAW_SENSORS);let Be=At;const St=class St extends a{constructor(t=new Uint8Array(0),e){super(St.opcode,e),this.data=t}static fromPayload(t){return new St(t,t)}};E(St,"opcode",s.NOTIFY_SCALE_FAULTY);let ke=St;const lt=class lt extends a{constructor(t){super(lt.opcode,t)}static fromPayload(t){return new lt(t)}};E(lt,"opcode",s.CODE_OPERATION_SUCCESS);let tn=lt;const Nt=class Nt extends a{constructor(t=0,e){super(Nt.opcode,e),this.errorCode=t}static fromPayload(t){let e=0;return t.length>0&&(e=t[0]),new Nt(e,t)}};E(Nt,"opcode",s.CODE_OPERATION_ERROR);let en=Nt;const Ct=class Ct extends a{constructor(t=0,e){super(Ct.opcode,e),this.count=t}static fromPayload(t){let e=0;return t.length>=2&&(e=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0,!1)),new Ct(e,t)}};E(Ct,"opcode",s.NOTIFY_LOGS_COUNT);let nn=Ct;const wt=class wt extends a{constructor(t){super(wt.opcode,t)}static fromPayload(t){return new wt(t)}};E(wt,"opcode",s.VALID_OPEN_CODE);let rn=wt;const It=class It extends a{constructor(t){super(It.opcode,t)}static fromPayload(t){return new It(t)}};E(It,"opcode",s.INVALID_OPEN_CODE);let sn=It;const ft=class ft extends a{constructor(t=!1,e){super(ft.opcode,e),this.isOpen=t}static fromPayload(t){let e=!1;if(t.length>=2){const r=t[0];e=t[1]===1&&r===0}return new ft(e,t)}};E(ft,"opcode",s.NOTIFY_DOOR_STATUS);let En=ft;const Dt=class Dt extends a{constructor(t=!1,e){super(Dt.opcode,e),this.isOpen=t}static fromPayload(t){let e=!1;return t.length>=2&&(e=t[1]===1&&t[0]===0),new Dt(e,t)}};E(Dt,"opcode",s.ANSWER_DOOR_STATUS);let cn=Dt;const dt=class dt extends a{constructor(t=0,e=0,r){super(dt.opcode,r),this.masterCount=t,this.otherCount=e}static fromPayload(t){let e=0,r=0;if(t.length>=4){const i=new DataView(t.buffer,t.byteOffset,t.byteLength);e=i.getUint16(0,!1),r=i.getUint16(2,!1)}return new dt(e,r,t)}};E(dt,"opcode",s.NOTIFY_CODES_COUNT);let on=dt;const gt=class gt extends a{constructor(e="",r){super(gt.opcode,r);E(this,"status","found");this.uid=e}static fromPayload(e){const r=d(e);return new gt(r,e)}};E(gt,"opcode",s.NOTIFY_NFC_TAG_FOUND);let an=gt;const Lt=class Lt extends a{constructor(e){super(Lt.opcode,e);E(this,"status","already_exists")}static fromPayload(e){return new Lt(e)}};E(Lt,"opcode",s.ERROR_NFC_TAG_ALREADY_EXISTS_SCAN);let _n=Lt;const Ut=class Ut extends a{constructor(e){super(Ut.opcode,e);E(this,"status","timeout")}static fromPayload(e){return new Ut(e)}};E(Ut,"opcode",s.ERROR_NFC_SCAN_TIMEOUT);let Tn=Ut;const Ft=class Ft extends a{constructor(t){super(Ft.opcode,t)}static fromPayload(t){return new Ft(t)}};E(Ft,"opcode",s.NOTIFY_NFC_TAG_REGISTERED);let On=Ft;const Gt=class Gt extends a{constructor(t){super(Gt.opcode,t)}static fromPayload(t){return new Gt(t)}};E(Gt,"opcode",s.NOTIFY_NFC_TAG_REGISTERED_ERROR_ALREADY_EXISTS);let Rn=Gt;const mt=class mt extends a{constructor(t){super(mt.opcode,t)}static fromPayload(t){return new mt(t)}};E(mt,"opcode",s.NOTIFY_NFC_TAG_UNREGISTERED);let hn=mt;const yt=class yt extends a{constructor(t){super(yt.opcode,t)}static fromPayload(t){return new yt(t)}};E(yt,"opcode",s.LOG_END_HISTORY);let un=yt;const Yt=class Yt extends a{constructor(t){super(Yt.opcode,t)}static fromPayload(t){return new Yt(t)}};E(Yt,"opcode",s.NOTIFY_CODE_GENERATION_SUCCESS);let An=Yt;const xt=class xt extends a{constructor(t){super(xt.opcode,t)}static fromPayload(t){return new xt(t)}};E(xt,"opcode",s.NOTIFY_CODE_GENERATION_ERROR);let Sn=xt;const Pt=class Pt extends a{constructor(t=0,e){super(Pt.opcode,e),this.progress=t}static fromPayload(t){let e=0;return t.length>0&&(e=t[0]),new Pt(e,t)}};E(Pt,"opcode",s.NOTIFY_CODE_GENERATION_PROGRESS);let ln=Pt;const pt=class pt extends a{constructor(t){super(pt.opcode,t)}static fromPayload(t){return new pt(t)}};E(pt,"opcode",s.NOTIFY_SET_CONFIGURATION_SUCCESS);let Nn=pt;const Kt=class Kt extends a{constructor(t){super(Kt.opcode,t)}static fromPayload(t){return new Kt(t)}};E(Kt,"opcode",s.ERROR_CRC);let Cn=Kt;const vt=class vt extends a{constructor(t){super(vt.opcode,t)}static fromPayload(t){return new vt(t)}};E(vt,"opcode",s.ERROR_UNAUTHORIZED);let wn=vt;const Vt=class Vt extends a{constructor(t){super(Vt.opcode,t)}static fromPayload(t){return new Vt(t)}};E(Vt,"opcode",s.ERROR_BAD_REQUEST);let In=Vt;class S extends a{constructor(e,r=0,i){super(e,i);E(this,"age",0);E(this,"date");this.age=r,this.date=new Date(Date.now()-r*1e3)}}const bt=class bt extends S{constructor(t=0,e="",r="",i){super(bt.opcode,t,i),this.code=e,this.connectedMac=r}static fromPayload(t){let e=0,r="",i="";t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);const c=3;if(t.length>=c+6&&(r=_(t.slice(c,c+6))),t.length>=17){const o=t.slice(11,17);i=Array.from(o).reverse().map(T=>T.toString(16).padStart(2,"0").toUpperCase()).join(":")}return new bt(e,r,i,t)}};E(bt,"opcode",s.LOG_CODE_BLE_VALID);let fn=bt;const Mt=class Mt extends S{constructor(t=0,e="",r="",i){super(Mt.opcode,t,i),this.code=e,this.connectedMac=r}static fromPayload(t){let e=0,r="",i="";t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);const c=3;if(t.length>=c+6&&(r=_(t.slice(c,c+6))),t.length>=17){const o=t.slice(11,17);i=Array.from(o).reverse().map(T=>T.toString(16).padStart(2,"0").toUpperCase()).join(":")}return new Mt(e,r,i,t)}};E(Mt,"opcode",s.LOG_CODE_BLE_INVALID);let Dn=Mt;const Wt=class Wt extends S{constructor(t=0,e="",r){super(Wt.opcode,t,r),this.code=e}static fromPayload(t){let e=0,r="";t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);const i=3;return t.length>=i+6&&(r=_(t.slice(i,i+6))),new Wt(e,r,t)}};E(Wt,"opcode",s.LOG_CODE_KEY_VALID);let dn=Wt;const $t=class $t extends S{constructor(t=0,e="",r){super($t.opcode,t,r),this.code=e}static fromPayload(t){let e=0,r="";t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);const i=3;return t.length>=i+6&&(r=_(t.slice(i,i+6))),new $t(e,r,t)}};E($t,"opcode",s.LOG_CODE_KEY_INVALID);let gn=$t;const Ht=class Ht extends S{constructor(e=0,r){super(Ht.opcode,e,r);E(this,"status","open")}static fromPayload(e){let r=0;return e.length>=3&&(r=e[0]<<16|e[1]<<8|e[2]),new Ht(r,e)}};E(Ht,"opcode",s.LOG_DOOR_OPEN);let Ln=Ht;const Xt=class Xt extends S{constructor(e=0,r){super(Xt.opcode,e,r);E(this,"status","closed")}static fromPayload(e){let r=0;return e.length>=3&&(r=e[0]<<16|e[1]<<8|e[2]),new Xt(r,e)}};E(Xt,"opcode",s.LOG_DOOR_CLOSE);let Un=Xt;const Qt=class Qt extends S{constructor(t=0,e){super(Qt.opcode,t,e)}static fromPayload(t){let e=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),new Qt(e,t)}};E(Qt,"opcode",s.LOG_HISTORY_ERASE);let Fn=Qt;const jt=class jt extends S{constructor(t=0,e){super(jt.opcode,t,e)}static fromPayload(t){let e=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),new jt(e,t)}};E(jt,"opcode",s.POWER_ON);let Gn=jt;const Zt=class Zt extends S{constructor(t=0,e=0,r){super(Zt.opcode,t,r),this.reason=e}static fromPayload(t){let e=0,r=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),t.length>3&&(r=t[3]),new Zt(e,r,t)}};E(Zt,"opcode",s.POWER_OFF);let mn=Zt;const zt=class zt extends S{constructor(t=0,e){super(zt.opcode,t,e)}static fromPayload(t){let e=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),new zt(e,t)}};E(zt,"opcode",s.BLOCK_RESET);let yn=zt;const Jt=class Jt extends S{constructor(t=0,e){super(Jt.opcode,t,e)}static fromPayload(t){let e=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),new Jt(e,t)}};E(Jt,"opcode",s.BLE_REBOOT);let Yn=Jt;const qt=class qt extends S{constructor(t=0,e=new Uint8Array(0),r){super(qt.opcode,t,r),this.data=e}static fromPayload(t){let e=0,r=new Uint8Array(0);return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),t.length>3&&(r=t.slice(3)),new qt(e,r,t)}};E(qt,"opcode",s.LOG_EVENT_SCALE_MEASURE);let xn=qt;const Bt=class Bt extends S{constructor(t=0,e){super(Bt.opcode,t,e)}static fromPayload(t){let e=0;return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),new Bt(e,t)}};E(Bt,"opcode",s.LOG_EVENT_KEY_OPENING);let Pn=Bt;const kt=class kt extends S{constructor(t=0,e=0,r){super(kt.opcode,t,r),this.errorCode=e}static fromPayload(t){let e=0,r=0;t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);const i=3;return t.length>i&&(r=t[i]),new kt(e,r,t)}};E(kt,"opcode",s.LOG_EVENT_ERROR);let pn=kt;const te=class te extends S{constructor(t=0,e=0,r="",i){super(te.opcode,t,i),this.tagType=e,this.uid=r}static fromPayload(t){let e=0,r=0,i="";t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]);let c=3;if(t.length>c&&(r=t[c],c++),t.length>c){const o=t[c];c++,t.length>=c+o&&(i=d(t.slice(c,c+o)))}return new te(e,r,i,t)}};E(te,"opcode",s.LOG_EVENT_NFC_OPENING);let Kn=te;const ee=class ee extends S{constructor(t=0,e=new Uint8Array(0),r){super(ee.opcode,t,r),this.data=e}static fromPayload(t){let e=0,r=new Uint8Array(0);return t.length>=3&&(e=t[0]<<16|t[1]<<8|t[2]),t.length>3&&(r=t.slice(3)),new ee(e,r,t)}};E(ee,"opcode",s.LOG_EVENT_NFC_REGISTERING);let vn=ee;const qn=[ae,_e,Te,Oe,Re,he,ue,Ae,Se,le,Ne,Ce,we,Ie,fe,De,de,ge,Ve,Le,Ue,Fe,Ge,se,ie,me,be,ye,Ye,xe,Pe,Me,pe,We,$e,He,Xe,Qe,je,Ze,ze,Je,qe,Be,ke,tn,en,nn,rn,sn,En,cn,on,an,_n,Tn,On,Rn,hn,un,An,Sn,ln,Nn,Cn,wn,In,fn,Dn,dn,gn,Ln,Un,Fn,Gn,mn,yn,Yn,xn,Pn,pn,Kn,vn];class Hn{static createFromPayload(t,e){if(t.length<3)return;const r=t[0],i=t[1];if(t.length<i+3)return;const c=t.subarray(2,2+i),o=t[i+2],T=$n(t.subarray(0,i+2));if(o!==T){e&&e("warn","checksum_error",{opcode:r,expected:T,received:o});return}return this.fromResponse(r,c)}static getConstructor(t){return this.registry.get(t)}static fromResponse(t,e){const r=this.getConstructor(t);if(r)return r.fromPayload(e)}static createRegeneratePackets(t,e){const r=typeof e=="string"?I(e):e;if(r.length!==32)throw new Error("Master Key must be 32 bytes");return[new se(t,r.slice(0,16)),new ie(t,r.slice(16,32))]}}E(Hn,"registry",new Map(qn.map(t=>[t.opcode,t])));async function Bn(n){const t=await n.read(N.BATTERY_LEVEL).catch(()=>{});return tr(t)}async function kn(n){const t=await n.read(N.CUSTOM_BATTERY).catch(()=>{});return er(t)}function tr(n){const t=n==null?void 0:n[0];return t!==void 0&&t!==g?t:void 0}function er(n){if(!n||n.length===0||Array.from(n).every(r=>r===g))return;const t=n[n.length-1],e=t!==g?t-25:void 0;if(n.length===6)return{format:"measures-first-min-mean-max-last",level:n[2],temperature:e,details:{first:n[0],min:n[1],mean:n[2],max:n[3],last:n[4]}};if(n.length===4)return{format:"measures-t1-t5-t10",level:n[0],temperature:e,details:{t1:n[0],t5:n[1]!==g?n[1]:void 0,t10:n[2]!==g?n[2]:void 0}}}class Mn{constructor(t){E(this,"transport");E(this,"logger");E(this,"responseHandlers",[]);E(this,"listeners",[]);E(this,"commandQueue",Promise.resolve());if(t!=null&&t.transport)this.transport=t.transport;else{if(!(t!=null&&t.device)&&(typeof navigator>"u"||!navigator.bluetooth))throw new R(O.WEB_BLUETOOTH_NOT_SUPPORTED,"No transport provided and Web Bluetooth is not supported.");this.transport=new zn(t==null?void 0:t.device)}t!=null&&t.logger&&(this.logger=t.logger)}log(t,e,r){this.logger&&this.logger(t,e,r)}async connect(){await this.transport.connect(),await this.transport.subscribe(t=>this.handleNotification(t))}async disconnect(){await this.transport.disconnect()}async getBatteryLevel(){return Bn(this.transport)}async getBatteryStats(){return kn(this.transport)}async readCharacteristic(t){return this.transport.read(t)}async send(t){const e=this.commandQueue.then(async()=>{const r=t.encode();this.log("debug","send",{opcode:t.opcode,length:r.length}),await this.transport.write(r)});return this.commandQueue=e.catch(r=>{this.log("error","error",{opcode:t.opcode,error:r})}),e}onPacket(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}async fetchHistory(t=2e3){const e=[];return new Promise((r,i)=>{let c;const o=()=>{c&&clearTimeout(c),c=setTimeout(()=>{T(),i(new R(O.TIMEOUT,"Timeout during history transfer"))},t)},T=this.onPacket(A=>{A instanceof S?(e.push(A),o()):A.opcode===s.LOG_END_HISTORY&&(c&&clearTimeout(c),T(),r(e))});o(),this.send(new Te).catch(A=>{c&&clearTimeout(c),T(),i(A)})})}handleNotification(t){try{const e=Hn.createFromPayload(t,(i,c,o)=>this.log(i,c,o));if(!e)return;this.log("debug","receive",{opcode:e.opcode}),this.listeners.forEach(i=>{try{i(e)}catch(c){this.log("error","listener_error",{opcode:e.opcode,error:c})}});const r=this.responseHandlers.findIndex(i=>i.opcodes.includes(e.opcode));if(r!==-1){const i=this.responseHandlers[r];this.responseHandlers.splice(r,1),i.resolve(e)}}catch(e){this.log("error","error",{error:e})}}waitForPacket(t,e=5e3){return this.waitForOneOf([t],e)}waitForOneOf(t,e=5e3){return new Promise((r,i)=>{const c=setTimeout(()=>{const o=this.responseHandlers.findIndex(T=>T.opcodes.length===t.length&&T.opcodes.every((A,C)=>A===t[C]));o!==-1&&this.responseHandlers.splice(o,1),i(new R(O.TIMEOUT,`Timeout waiting for opcodes ${t.map(T=>"0x"+T.toString(16)).join(", ")}`))},e);this.responseHandlers.push({opcodes:t,resolve:o=>{clearTimeout(c),r(o)}})})}}var Ee,D;class sr{constructor(t){E(this,"client");E(this,"_hardwareInfo",null);Ke(this,Ee,null);Ke(this,D,null);t instanceof Mn?this.client=t:this.client=new Mn(t)}setCredentials(t){let e;if(typeof t=="string"?e=t.replace(/[^0-9A-Fa-f]/g,"").toUpperCase():e=d(t),e.length!==64)throw new R(O.INVALID_PARAMETER,`Master Key must be 32 bytes (64 hex chars), got ${e.length} hex chars`);ve(this,Ee,e),ve(this,D,e.slice(-8))}getConfigKeyOrThrow(){if(!ce(this,D))throw new R(O.INVALID_PARAMETER,"Credentials not set. Call setCredentials() first.");return ce(this,D)}async connect(){await this.client.connect(),await this.refreshVersions()}async disconnect(){await this.client.disconnect()}get hardwareInfo(){return this._hardwareInfo}get masterKey(){return ce(this,Ee)}async refreshVersions(){const t=new TextDecoder("utf-8"),e=await this.client.readCharacteristic(N.SOFTWARE_REVISION),r=t.decode(e).replace(/\0/g,"").trim(),i=await this.client.readCharacteristic(N.FIRMWARE_REVISION),c=t.decode(i).replace(/\0/g,"").trim();this._hardwareInfo=this.deriveHardwareInfo(c,r)}deriveHardwareInfo(t,e){let r="Unknown",i="Unknown";return t.includes("10/125")?(r="4.0",i="nRF52833"):t.includes("10/cd")&&(r="3.0",i="nRF52811"),{firmwareRevision:t,softwareRevision:e,hardwareVersion:r,chipset:i}}compareSemVer(t,e){const r=t.split(".").map(Number),i=e.split(".").map(Number),c=Math.max(r.length,i.length);for(let o=0;o<c;o++){const T=r[o]||0,A=i[o]||0;if(T>A)return 1;if(T<A)return-1}return 0}checkRequirements(t){if(!this._hardwareInfo)throw new R(O.UNKNOWN_ERROR,"Hardware info not available. Not connected?",{requirements:t});if(t.minHw&&this._hardwareInfo.hardwareVersion!==t.minHw)throw new R(O.UNSUPPORTED_FEATURE,`${t.featureName} requires Hardware Version ${t.minHw} (detected ${this._hardwareInfo.hardwareVersion})`,{required:t,actual:this._hardwareInfo});if(t.minSw&&this.compareSemVer(this._hardwareInfo.softwareRevision,t.minSw)<0)throw new R(O.UNSUPPORTED_FEATURE,`${t.featureName} requires Software Version >= ${t.minSw} (detected ${this._hardwareInfo.softwareRevision})`,{required:t,actual:this._hardwareInfo})}async scanNFCTags(t=1e4){const e=this.getConfigKeyOrThrow();this.checkRequirements({minHw:"4.0",minSw:"4.3.3",featureName:"NFC Scan"}),await this.client.send(new Ue(e));const r=await this.client.waitForOneOf([s.NOTIFY_NFC_TAG_FOUND,s.ERROR_NFC_SCAN_TIMEOUT,s.ERROR_NFC_TAG_ALREADY_EXISTS_SCAN],t);if(r.opcode===s.NOTIFY_NFC_TAG_FOUND){const i=r;return{tagId:i.uid,register:()=>this.registerNfcTag(i.uid)}}else{if(r.opcode===s.ERROR_NFC_SCAN_TIMEOUT)throw new R(O.TIMEOUT,"NFC Scan timed out");if(r.opcode===s.ERROR_NFC_TAG_ALREADY_EXISTS_SCAN)throw new R(O.ALREADY_EXISTS,"NFC Tag already exists")}throw new R(O.UNKNOWN_ERROR,`Unexpected packet during scan: ${r.opcode}`)}async registerNfcTag(t){const e=this.getConfigKeyOrThrow();return this.checkRequirements({minHw:"4.0",minSw:"4.3.3",featureName:"NFC Register"}),await this.client.send(new Fe(e,t)),(await this.client.waitForOneOf([s.NOTIFY_NFC_TAG_REGISTERED,s.NOTIFY_NFC_TAG_REGISTERED_ERROR_ALREADY_EXISTS])).opcode===s.NOTIFY_NFC_TAG_REGISTERED}async unregisterNfcTag(t){const e=this.getConfigKeyOrThrow();return this.checkRequirements({minHw:"4.0",minSw:"4.3.3",featureName:"NFC Unregister"}),await this.client.send(new Ge(e,t)),await this.client.waitForPacket(s.NOTIFY_NFC_TAG_UNREGISTERED),!0}async openDoor(t){return await this.client.send(new ae(t)),(await this.client.waitForOneOf([s.VALID_OPEN_CODE,s.INVALID_OPEN_CODE])).opcode===s.VALID_OPEN_CODE}async getDoorStatus(){return await this.client.send(new _e),(await this.client.waitForOneOf([s.ANSWER_DOOR_STATUS,s.NOTIFY_DOOR_STATUS])).isOpen}async getLogsCount(){return await this.client.send(new Re),(await this.client.waitForPacket(s.NOTIFY_LOGS_COUNT)).count}async countCodes(){await this.client.send(new ge);const t=await this.client.waitForPacket(s.NOTIFY_CODES_COUNT);return{masterCount:t.masterCount,otherCount:t.otherCount}}async testBattery(){await this.client.send(new he)}async getBatteryLevel(){return this.client.getBatteryLevel()}async getBatteryStats(){return this.client.getBatteryStats()}async reboot(){await this.client.send(new Oe)}async fetchHistory(t){return this.client.fetchHistory(t)}async createMasterCode(t,e){const r=this.getConfigKeyOrThrow();return await this.client.send(new fe(r,t,e)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async createSingleUseCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new De(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async createMultiUseCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new de(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async deleteMasterCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new le(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async deleteSingleUseCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new Ne(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async deleteMultiUseCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new Ce(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async reactivateCode(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new we(e,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async editMasterCode(t,e){const r=this.getConfigKeyOrThrow();return await this.client.send(new ue(r,t,e)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async setConfiguration(t){const e=this.getConfigKeyOrThrow();return await this.client.send(new Le(e,t.type,t.value)),(await this.client.waitForOneOf([s.NOTIFY_SET_CONFIGURATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.NOTIFY_SET_CONFIGURATION_SUCCESS}async convertCodeType(t,e){const r=this.getConfigKeyOrThrow();return e===Wn.Multi?await this.client.send(new Ae(r,t)):await this.client.send(new Se(r,t)),(await this.client.waitForOneOf([s.CODE_OPERATION_SUCCESS,s.CODE_OPERATION_ERROR])).opcode===s.CODE_OPERATION_SUCCESS}async initialize(t,e){let r;if(typeof t=="string"){const i=t.replace(/[^0-9A-Fa-f]/g,"");if(i.length!==64)throw new R(O.INVALID_PARAMETER,`Seed string must be 32 bytes (64 hex chars), got ${i.length}`);r=I(i)}else r=t;if(r.length!==32)throw new R(O.INVALID_PARAMETER,`Seed bytes must be 32 bytes, got ${r.length}`);return new Promise((i,c)=>{let o;const T=A=>{A.opcode===s.NOTIFY_CODE_GENERATION_PROGRESS?e&&e(A.progress):A.opcode===s.NOTIFY_CODE_GENERATION_SUCCESS?(o&&o(),i(!0)):A.opcode===s.NOTIFY_CODE_GENERATION_ERROR&&(o&&o(),i(!1))};o=this.client.onPacket(T),this.client.send(new Ie(r)).catch(A=>{o&&o(),c(A)})})}async regenerateMasterKey(t,e){const r=this.getConfigKeyOrThrow();let i;if(typeof t=="string"){const T=t.replace(/[^0-9A-Fa-f]/g,"");if(T.length!==64)throw new R(O.INVALID_PARAMETER,`Master Key string must be 32 bytes (64 hex chars), got ${T.length}`);i=I(T)}else i=t;if(i.length!==32)throw new R(O.INVALID_PARAMETER,`Master Key bytes must be 32 bytes, got ${i.length}`);const c=i.slice(0,16),o=i.slice(16,32);return new Promise((T,A)=>{let C;const Xn=f=>{f.opcode===s.NOTIFY_CODE_GENERATION_PROGRESS?e&&e(f.progress):f.opcode===s.NOTIFY_CODE_GENERATION_SUCCESS?(C&&C(),T(!0)):f.opcode===s.NOTIFY_CODE_GENERATION_ERROR&&(C&&C(),T(!1))};C=this.client.onPacket(Xn),this.client.send(new se(r,c)).then(()=>this.client.send(new ie(r,o))).catch(f=>{C&&C(),A(f)})})}async bondScale(){return await this.client.send(new me),(await this.client.waitForOneOf([s.NOTIFY_SCALE_BONDING_SUCCESS,s.NOTIFY_SCALE_BONDING_ERROR])).opcode===s.NOTIFY_SCALE_BONDING_SUCCESS}async getScaleWeight(){return await this.client.send(new Pe),(await this.client.waitForPacket(s.NOTIFY_SCALE_MEASURE_WEIGHT)).weight}async tareScale(t){return t?(await this.client.send(new Ye),await this.client.waitForPacket(s.NOTIFY_SCALE_TARE_EMPTY_OK)):(await this.client.send(new xe),await this.client.waitForPacket(s.NOTIFY_SCALE_TARE_LOADED_OK)),!0}async forgetScale(){return await this.client.send(new ye),await this.client.waitForPacket(s.NOTIFY_SCALE_BONDING_FORGET_SUCCESS),!0}async getScaleRawSensors(){return await this.client.send(new pe),(await this.client.waitForPacket(s.NOTIFY_SCALE_RAW_SENSORS)).data}}Ee=new WeakMap,D=new WeakMap;export{sr as B};
